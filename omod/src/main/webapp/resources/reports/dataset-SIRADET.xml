<org.openmrs.module.reporting.dataset.definition.SqlDataSetDefinition id="1" uuid="6462dd79-d0bf-4686-97d1-fa29ad2ae03d" retired="false">
  <name>SI-RADET</name>
  <description>Export of the RADET dataset</description>
  <creator id="2" uuid="1c3db49d-440a-11e6-a65c-00e04c680037"/>
  <dateCreated id="3">2019-07-08 23:21:26 UTC</dateCreated>
  <changedBy reference="2"/>
  <dateChanged id="4">2021-09-10 04:05:15 UTC</dateChanged>
  <parameters id="5">
    <org.openmrs.module.reporting.evaluation.parameter.Parameter id="6">
      <name>startDate</name>
      <label>Start Date</label>
      <type>java.util.Date</type>
      <required>true</required>
    </org.openmrs.module.reporting.evaluation.parameter.Parameter>
    <org.openmrs.module.reporting.evaluation.parameter.Parameter id="7">
      <name>endDate</name>
      <label>End Date</label>
      <type>java.util.Date</type>
      <required>true</required>
    </org.openmrs.module.reporting.evaluation.parameter.Parameter>
  </parameters>
  <id>35</id>
  <sqlQuery>select &#xd;
nigeria_datimcode_mapping.state_name as `State`,&#xd;
nigeria_datimcode_mapping.lga_name as `LGA`,&#xd;
gp1.property_value as DatimCode,&#xd;
gp2.property_value as FacilityName,&#xd;
pid1.identifier as `PatientUniqueID`,&#xd;
pid2.identifier as  `PatientHospitalNo`,&#xd;
pid3.identifier as  `ANCNoIdentifier`,&#xd;
gettextvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165567,16,:endDate)) as `ANCNoConceptID`,&#xd;
pid4.identifier as  `HTSNo`,&#xd;
person.gender as `Sex`,&#xd;
MAX(IF(obs.concept_id=159599,IF(TIMESTAMPDIFF(YEAR,person.birthdate,obs.value_datetime)&gt;=5,TIMESTAMPDIFF(YEAR,person.birthdate,obs.value_datetime),@ageAtStart:=0),null)) as  `AgeAtStartOfARTYears`,&#xd;
MAX(IF(obs.concept_id=159599,IF(TIMESTAMPDIFF(YEAR,person.birthdate,obs.value_datetime)&lt;5,TIMESTAMPDIFF(MONTH,person.birthdate,obs.value_datetime),null),null)) as `AgeAtStartOfARTMonths`,&#xd;
&#xd;
MAX(IF(obs.concept_id=160540,cn1.name,null)) as CareEntryPoint,&#xd;
&#xd;
getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,166369,23,:endDate)) as `KPType`,&#xd;
&#xd;
TIMESTAMPDIFF(MONTH,getdatevalueobsid(getmaxconceptobsid(patient.patient_id,159599,:endDate)),getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate))) as MonthsOnART,&#xd;
&#xd;
MAX(IF(obs.concept_id=160534,DATE_FORMAT(obs.value_datetime,&apos;%d-%b-%Y&apos;),null)) as DateTransferredIn,&#xd;
&#xd;
MAX(IF(obs.concept_id=165242,cn1.name,null)) as TransferInStatus,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsid(patient.patient_id,159599,:endDate)),&apos;%d-%b-%Y&apos;) as `ARTStartDate`,&#xd;
&#xd;
&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate)),&apos;%d-%b-%Y&apos;) as `LastPickupDate`,&#xd;
&#xd;
DATE_FORMAT(getencounterdate(getlastvisitdate(patient.patient_id,:endDate)),&apos;%d-%b-%Y&apos;) as LastVisitDate,&#xd;
&#xd;
getconceptval(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate),159368,patient.patient_id) as `DaysOfARVRefil`,&#xd;
&#xd;
gettextvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,166406,27,:endDate))&#xd;
as `PillBalance`,&#xd;
&#xd;
MAX(IF(obs2.concept_id=165708,cn2.name,null)) as `InitialRegimenLine`,&#xd;
&#xd;
MAX(IF(obs2.concept_id=165708,getcurrentregimen(obs2.value_coded,obs2.encounter_id),null)) as `InitialRegimen`,&#xd;
&#xd;
getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165708,27,:endDate)) as `CurrentRegimenLine`,&#xd;
&#xd;
getcurrentregimen(getcodedintvalueobs(getmaxconceptobsidwithformid(patient.patient_id,165708,27,:endDate)),getencounterid(getmaxconceptobsidwithformid(patient.patient_id,165708,27,:endDate))) as `CurrentRegimen`,&#xd;
&#xd;
MAX(IF((obs.concept_id=165050 AND person.gender=&apos;F&apos;),cn1.name,null)) as `PregnancyStatus`,&#xd;
MAX(IF((obs.concept_id=165050 AND person.gender=&apos;F&apos;),DATE_FORMAT(obs.obs_datetime,&apos;%d-%b-%Y&apos;),null)) as `PregnancyStatusDate`,&#xd;
MAX(IF((obs.concept_id=5596 AND person.gender=&apos;F&apos;),DATE_FORMAT(obs.value_datetime,&apos;%d-%b-%Y&apos;),null)) as `EDD`,&#xd;
&#xd;
MAX(IF((obs.concept_id=1427 AND person.gender=&apos;F&apos;),DATE_FORMAT(obs.value_datetime,&apos;%d-%b-%Y&apos;),null)) as `LMP`,&#xd;
&#xd;
TIMESTAMPDIFF(&#xd;
WEEK,&#xd;
MAX(IF((obs.concept_id=1427 AND person.gender=&apos;F&apos;),obs.value_datetime,null)),&#xd;
:endDate) as `EstimatedGestationAgeWeeks`,&#xd;
&#xd;
getnumericvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)) as `CurrentViralLoad(c/ml)`,&#xd;
&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)),&apos;%d-%b-%Y&apos;) as `ViralLoadEncounterDate`,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)),159951)),&apos;%d-%b-%Y&apos;) as `ViralLoadSampleCollectionDate`,&#xd;
&#xd;
DATE_FORMAT(getreporteddate(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)),165414,patient.patient_id),&apos;%d-%b-%Y&apos;) &#xd;
as `ViralLoadReportedDate`,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)),166423)),&apos;%d-%b-%Y&apos;) as `ResultDate`,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)),166424)),&apos;%d-%b-%Y&apos;) as `AssayDate`,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)),166425)),&apos;%d-%b-%Y&apos;) as `ApprovalDate`,&#xd;
&#xd;
&#xd;
getcodedvalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,856,21,:endDate)),164980)) as `ViralLoadIndication`,&#xd;
&#xd;
getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165470,13,:endDate)) as PatientOutcome,&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,165470,13,:endDate)),&apos;%d-%b-%Y&apos;) as PatientOutcomeDate,&#xd;
&#xd;
IFNULL (getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165470,13,:endDate)),getoutcome(&#xd;
getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate)),&#xd;
getconceptval(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate),159368,patient.patient_id) ,&#xd;
28,&#xd;
IF(:endDate IS NULL or :endDate = &apos;&apos;, CURDATE(),:endDate)&#xd;
&#xd;
))  as `CurrentARTStatus`,&#xd;
&#xd;
&#xd;
&#xd;
getcodedvalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate)),166148)) as `DispensingModality`,&#xd;
&#xd;
getcodedvalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate)),166276)) as `FacilityDispensingModality`,&#xd;
&#xd;
getcodedvalueobsid(getobswithencounterid(getencounterid(getmaxconceptobsidwithformid(patient.patient_id,162240,27,:endDate)),166363)) as `DDDDispensingModality`,&#xd;
&#xd;
&#xd;
MAX(IF(obs.concept_id=165775,DATE_FORMAT(obs.value_datetime,&apos;%d-%b-%Y&apos;),null)) as `DateReturnedToCare`,&#xd;
&#xd;
MAX(IF(obs.concept_id=165469,DATE_FORMAT(obs.value_datetime,&apos;%d-%b-%Y&apos;),null)) as `DateOfTermination`,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsidwithformid(patient.patient_id,5096,27,:endDate)),&apos;%d-%b-%Y&apos;) as `PharmacyNextAppointment`,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsidwithformid(patient.patient_id,5096,14,:endDate)),&apos;%d-%b-%Y&apos;) as `ClinicalNextAppointment`,&#xd;
&#xd;
IF(TIMESTAMPDIFF(YEAR,person.birthdate,curdate())&gt;=5,TIMESTAMPDIFF(YEAR,person.birthdate,curdate()),null) as `CurrentAgeYears`,&#xd;
IF(TIMESTAMPDIFF(YEAR,person.birthdate,curdate())&lt;5,TIMESTAMPDIFF(MONTH,person.birthdate,curdate()),null) as `CurrentAgeMonths`,&#xd;
DATE_FORMAT(person.birthdate,&apos;%d-%b-%Y&apos;) as `DateOfBirth`,&#xd;
IF(person.dead=1,&quot;Dead&quot;,&quot;&quot;) as MarkAsDeseased,&#xd;
IF(person.dead=1,person.death_date,&quot;&quot;) as MarkAsDeseasedDeathDate,&#xd;
CONCAT(&quot;+234-&quot;,TRIM(LEADING &apos;0&apos; FROM psn_atr.value)) AS RegistrationPhoneNo,&#xd;
MAX(IF(obs.concept_id=159635,CONCAT(&quot;+234-&quot;,TRIM(LEADING &apos;0&apos; FROM obs.value_text)),null)) as `NextofKinPhoneNo`,&#xd;
MAX(IF(obs.concept_id=160642,CONCAT(&quot;+234-&quot;,TRIM(LEADING &apos;0&apos; FROM obs.value_text)),null)) as &#xd;
`TreatmentSupporterPhoneNo`,&#xd;
&#xd;
IF(biometrictable.patient_Id IS NOT NULL,&apos;Yes&apos;,&apos;No&apos;) as BiometricCaptured,&#xd;
&#xd;
IF(biometrictable.patient_Id IS NOT NULL,DATE_FORMAT(biometrictable.date_created,&apos;%d-%b-%Y&apos;),&quot;&quot;) as BiometricCaptureDate,&#xd;
&#xd;
IF(biometrictable.patient_Id IS NOT NULL,IF(invalidprint.patient_Id IS NOT NULL,&apos;No&apos;,&apos;Yes&apos;),&quot;&quot;) as ValidCapture,&#xd;
&#xd;
getnumericvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,5089,14,:endDate)) as `CurrentWeight(Kg)`,&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,5089,14,:endDate)),&apos;%d-%b-%Y&apos;) as `CurrentWeightDate`,&#xd;
getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,1659,14,:endDate)) as `TBStatus`,&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,1659,14,:endDate)),&apos;%d-%b-%Y&apos;) as `TBStatusDate`,&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsid(patient.patient_id,166096,:endDate)),&apos;%d-%b-%Y&apos;)&#xd;
as `INHStartDate`,&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsid(patient.patient_id,166096,:endDate)),&apos;%d-%b-%Y&apos;)&#xd;
as `INHStopDate`,&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformidvaluecoded(patient.patient_id,165727,27,1679,:endDate)),&apos;%d-%b-%Y&apos;) &#xd;
as `LastINHDispensedDate`,&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsid(patient.patient_id,1113,:endDate)),&apos;%d-%b-%Y&apos;) &#xd;
as `TBTreatmentStartDate`,&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsid(patient.patient_id,159431,:endDate)),&apos;%d-%b-%Y&apos;)&#xd;
 as `TBTreatmentStopDate`,&#xd;
 DATE_FORMAT(getencounterdate(getlastencounter(patient.patient_id,67,:endDate)),&apos;%d-%b-%Y&apos;) &#xd;
as `LastViralLoadSampleCollectionFormDate`,&#xd;
&#xd;
DATE_FORMAT(getencounterdate(getlastencounter(patient.patient_id,21,:endDate)),&apos;%d-%b-%Y&apos;) &#xd;
as `LastLabFormDate`,&#xd;
&#xd;
&#xd;
DATE_FORMAT(getencounterdate(getlastencounter(patient.patient_id,73,:endDate)),&apos;%d-%b-%Y&apos;) &#xd;
as `OTZEnrollmentDate`,&#xd;
&#xd;
DATE_FORMAT(getdatevalueobsid(getmaxconceptobsidwithformid(patient.patient_id,166008,73,:endDate)),&apos;%d-%b-%Y&apos;) &#xd;
as `OTZOutcomeDate`,&#xd;
DATE_FORMAT(pprg.date_enrolled,&apos;%d-%b-%Y&apos;) as EnrollmentDate,&#xd;
MAX(IF(obs2.concept_id in(164506,164507), cn2.name,null)) as `InitialFirstLineRegimen`,&#xd;
MAX(IF(obs2.concept_id in(164506,164507), DATE_FORMAT(obs2.obs_datetime,&apos;%d-%b-%Y&apos;),null)) as `InitialFirstLineRegimenDate`,&#xd;
MAX(IF(obs2.concept_id in(164513,164514), cn2.name,null)) as `InitialSecondLineRegimen`,&#xd;
MAX(IF(obs2.concept_id in(164513,164514), DATE_FORMAT(obs2.obs_datetime,&apos;%d-%b-%Y&apos;),null)) as `InitialSecondLineRegimenDate`,&#xd;
&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,getendofquarter(DATE_SUB(:endDate,INTERVAL 3 MONTH)))),&apos;%d-%b-%Y&apos;) as &#xd;
`LastPickupDatePreviousQuarter`,&#xd;
&#xd;
getconceptval(getmaxconceptobsidwithformid(patient.patient_id,162240,27,getendofquarter(DATE_SUB(:endDate,INTERVAL 3 MONTH))),159368,patient.patient_id) as &#xd;
`DrugDurationPreviousQuarter`,&#xd;
&#xd;
getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165470,13,getendofquarter(DATE_SUB(:endDate,INTERVAL 3 MONTH)))) as &#xd;
`PatientOutcomePreviousQuarter`,&#xd;
&#xd;
DATE_FORMAT(getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,165470,13,getendofquarter(DATE_SUB(:endDate,INTERVAL 3 MONTH)))),&apos;%d-%b-%Y&apos;) as &#xd;
`PatientOutcomeDatePreviousQuarter`,&#xd;
&#xd;
IFNULL(&#xd;
&#xd;
&#xd;
getcodedvalueobsid(getmaxconceptobsidwithformid(patient.patient_id,165470,13,DATE_SUB(:endDate,INTERVAL 3 MONTH))),&#xd;
&#xd;
getoutcome(&#xd;
getobsdatetime(getmaxconceptobsidwithformid(patient.patient_id,162240,27,getendofquarter(DATE_SUB(:endDate,INTERVAL 3 MONTH)))),&#xd;
getconceptval(getmaxconceptobsidwithformid(patient.patient_id,162240,27,getendofquarter(DATE_SUB(:endDate,INTERVAL 3 MONTH))),159368,patient.patient_id) ,&#xd;
28,&#xd;
IF(:endDate IS NULL or :endDate = &apos;&apos;, CURDATE(),getendofquarter(DATE_SUB(:endDate,INTERVAL 3 MONTH)))&#xd;
&#xd;
)&#xd;
&#xd;
)  as `ARTStatusPreviousQuarter`&#xd;
&#xd;
&#xd;
&#xd;
&#xd;
&#xd;
  from patient&#xd;
  INNER JOIN person on(person.person_id=patient.patient_id and patient.voided=0)&#xd;
  LEFT JOIN patient_identifier pid1 on(pid1.patient_id=patient.patient_id and patient.voided=0 and pid1.identifier_type=4 and pid1.voided=0)&#xd;
  &#xd;
  LEFT JOIN patient_identifier pid3 on(pid3.patient_id=patient.patient_id and patient.voided=0 and pid3.identifier_type=6 and pid3.voided=0)&#xd;
  &#xd;
  LEFT JOIN patient_identifier pid4 on(pid4.patient_id=patient.patient_id and patient.voided=0 and pid4.identifier_type=8 and pid4.voided=0)&#xd;
  &#xd;
  LEFT JOIN person_attribute psn_atr ON (person.person_id=psn_atr.person_id and psn_atr.person_attribute_type_id=8) &#xd;
  LEFT JOIN patient_program pprg on(pprg.patient_id=patient.patient_id and pprg.voided=0 and patient.voided=0 and pprg.program_id=1)&#xd;
  LEFT JOIN patient_identifier pid2 on(pid2.patient_id=patient.patient_id and patient.voided=0 and pid2.identifier_type=5 and pid2.voided=0)&#xd;
  LEFT JOIN&#xd;
  (select &#xd;
obs.person_id,&#xd;
obs.concept_id,&#xd;
 MAX(obs.obs_datetime) as last_date, &#xd;
MIN(obs.obs_datetime) as first_date&#xd;
from obs INNER JOIN encounter on(encounter.encounter_id=obs.encounter_id) where encounter.form_id!=48 and obs.voided=0 and obs.obs_datetime&lt;=:endDate and concept_id in(159599,165708,159368,164506,164513,164507,164514,165702,165703,165050,&#xd;
856,164980,165470,159635,5089,165988,1659,164852,166096,1113,159431,162240,165242,165724,166156,166158,165727,164982,165414,5596,165775,160540,165469,5096,1427,160642,160534) GROUP BY obs.person_id, obs.concept_id) as sinner on (sinner.person_id=patient.patient_id and patient.voided=0)&#xd;
INNER JOIN obs on(obs.person_id=patient.patient_id and obs.concept_id=sinner.concept_id and obs.obs_datetime=sinner.last_date and obs.voided=0 and obs.obs_datetime&lt;=:endDate)&#xd;
INNER JOIN obs obs2 on(obs2.person_id=patient.patient_id and obs2.concept_id=sinner.concept_id and obs2.obs_datetime=sinner.first_date and obs2.voided=0 and obs2.obs_datetime&lt;=:endDate)&#xd;
LEFT join encounter enc on(enc.encounter_id=obs.encounter_id and enc.voided=0 and obs.voided=0)&#xd;
left join concept_name cn1 on(obs.value_coded=cn1.concept_id and cn1.locale=&apos;en&apos; and cn1.locale_preferred=1)&#xd;
left join concept_name cn2 on(obs2.value_coded=cn2.concept_id and cn2.locale=&apos;en&apos; and cn2.locale_preferred=1)&#xd;
LEFT JOIN (&#xd;
   select &#xd;
   DISTINCT biometricinfo.patient_Id,biometricinfo.date_created&#xd;
   from &#xd;
   biometricinfo GROUP BY biometricinfo.patient_Id&#xd;
) as biometrictable &#xd;
on(patient.patient_id=biometrictable.patient_Id and patient.voided=0)&#xd;
LEFT JOIN (&#xd;
   select &#xd;
   DISTINCT biometricinfo.patient_Id&#xd;
   from &#xd;
   biometricinfo where template not like &apos;Rk1S%&apos; or CONVERT(new_template USING utf8) NOT LIKE &apos;Rk1S%&apos;&#xd;
) as invalidprint &#xd;
on(patient.patient_id=invalidprint.patient_Id and patient.voided=0)&#xd;
LEFT JOIN global_property gp1 on(gp1.property=&apos;facility_datim_code&apos;)&#xd;
LEFT JOIN global_property gp2 on(gp2.property=&apos;Facility_Name&apos;)&#xd;
LEFT JOIN nigeria_datimcode_mapping on(gp1.property_value=nigeria_datimcode_mapping.datim_code)&#xd;
LEFT JOIN (&#xd;
select &#xd;
encounter.patient_id,&#xd;
MAX(encounter.encounter_datetime) as last_visit_date&#xd;
from encounter&#xd;
where encounter.voided=0 and encounter.form_id!=13 and encounter.encounter_datetime&lt;=:endDate GROUP BY  encounter.patient_id&#xd;
) as enc_last on(enc_last.patient_id=patient.patient_id and patient.voided=0)&#xd;
WHERE patient.voided=0 and pid1.identifier IS NOT NULL&#xd;
GROUP BY patient.patient_id ;&#xd;
</sqlQuery>
</org.openmrs.module.reporting.dataset.definition.SqlDataSetDefinition>